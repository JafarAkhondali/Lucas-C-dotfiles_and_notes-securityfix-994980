#!/bin/bash

# Script for e-mails backup & keyword search
# Use offlineimap && mbox2eml
# Lucas Cimon 2011/11/19

IFS=$'\n'

# Script configuration
ORIG_MAIL_ROOT="$PC/Users/Lucas/ProfilsMozilla/Thunderbird"
BCKUP_MAIL_ROOT="$COMMON/An brun des vagues a lames/Correspondance"
BCKUP_DIR_PREFIX=Mails_

# Variables
VIEWMAIL=false
BCKUP_DIR=$BCKUP_MAIL_ROOT/$BCKUP_DIR_PREFIX$(date +%Y-%m-%d)

backup_mbox () {
	mkdir -p $BCKUP_DIR/$1
	mbox2eml -d $BCKUP_DIR/$1 -f $ORIG_MAIL_ROOT/Mail/$1
	echo "$1 backuped."
}

backup_pop_mail () {
	backup_mbox $1/Inbox
	backup_mbox $1/Sent
}

if [ "$1" = "-b" ] || [ "$1" = "--backup" ]; then
	# Backup IMAP
	sed -i "s~localfolders = .*~localfolders = $BCKUP_DIR/IMAG~" ~/.offlineimaprc
	offlineimap
	# Backup POP3
	backup_pop_mail pop.wanadoo.fr
	backup_pop_mail pop.orange.fr
	echo "Backup complete. You can now manually remove old mails." #TODO: add an option to remove all ?
elif [ "$1" = "-s" ] || [ "$1" = "--search" ]; then
	keyword="$2"
	shift;shift
	grep "$keyword" -rl "$BCKUP_MAIL_ROOT"/$BCKUP_DIR_PREFIX* | while read file; do
		print=true
		for word in $@; do
			if [ "$word" = "-t" ]; then
				VIEWMAIL=true
			else
				grep -q "$word" $file || print=false
			fi
		done
		if $VIEWMAIL; then
			$print && thunderbird "$file"
		else
			$print && echo "$file"
		fi
	done
else
	cat <<END
	USAGE: `basename $0` -b | --backup
	       `basename $0` -s | --search [<string> | -t]*
		   
The '-t' option trigger mail opening with thunderbird.
END
fi
