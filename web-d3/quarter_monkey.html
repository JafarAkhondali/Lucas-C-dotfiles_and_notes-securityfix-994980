<!DOCTYPE html>
<meta charset="UTF-8">
<style>
.node {
    cursor: pointer;
}
.node circle {
    fill: cornflowerblue;
    stroke: black;
}
.node circle:hover {
    fill-opacity:0.5;
}
.node circle.dead_end {
    fill: #FF4040;
}
.node text {
    fill: black;
    font: 16px sans-serif;
    dominant-baseline: middle;
    text-anchor: middle;
}
.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}
</style>
<body>
<script type="text/javascript" src="d3.v3.min.js"></script>
<script language="javascript1.5">
const SVG_WIDTH = 800, SVG_HEIGHT = 600;
const RADIUS = 15, VERTI_SPACING = 150;
const STARTING_RANGE = 10;

// Handy functions
if (!String.prototype.format) {
    String.prototype.format = function() {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function(match, nbr) { 
            return typeof args[nbr] != 'undefined' ? args[nbr] : match;
        });
    };
}
function range(start, end) { var range_array=[]; for (var i=start; i<end; ++i) { range_array.push(i); } return range_array; }
function log(o) { console.log(JSON.stringify(o, function(key, val) { if (key == "parent") return "PARENT_REF"; else return val })); return o }

// Rendering
function create_display() {
    d3.select("body").append("svg")
        .attr("width", SVG_WIDTH)
        .attr("height", SVG_HEIGHT)
        .append("g")
            .attr("id", "canvas")
            .attr("transform", "translate(" + RADIUS + "," + RADIUS + ")");
    var vis_tree = d3.layout.tree()
        .size([SVG_WIDTH - 2 * RADIUS, SVG_HEIGHT - 2 * RADIUS])
    return vis_tree;
}

function update_display(tree, vis_tree) {
    var svgContainer = d3.select("#canvas");
    
    var nodes = vis_tree.nodes(tree),
        links = vis_tree.links(nodes);

    nodes.forEach(function(d) { d.y = d.depth * VERTI_SPACING; });

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.x, d.y] });

    // The second parameter to ".data" here is a trick to keep the same nodes ordering
    var svgNodes = svgContainer.selectAll(".node").data(nodes, function(d) { return d.id || (d.id = g_nodes_count++); });
    var newSvgNodes = svgNodes.enter().append("g")
        .attr("class", "node")
    newSvgNodes.append("circle")
        .attr("r", RADIUS)
        .on("mousedown", onCircleClick);
    svgNodes.selectAll("g circle") // entering + already there
        .attr("class", function(node) { return node.dead_end ? "dead_end" : ""});
    newSvgNodes.append("text")
        .text(function(node) { return node.nbr });
    svgNodes // entering + already there
        .attr("transform", function(node) { return "translate(" + node.x + ", " + node.y + ")" });

    var svgLinks = svgContainer.selectAll("path.link").data(links);
    svgLinks.enter().insert("path", "g")
        .attr("class", "link");
    svgLinks // entering + already there
        .attr("d", diagonal);
}

// Tree building logic
function onCircleClick(node) {
    populate_tree(g_tree, node);
    update_display(g_tree, g_vis_tree);
}

function populate_tree(tree, picked_node) {
    if (picked_node.children) {
        return;
    }
    var new_numbers = compute_primes_starting_with(picked_node.nbr);
    if (new_numbers) {
        var new_nodes = new_numbers.reduce(function(arr, nbr) {
            return arr.concat([{ "nbr":nbr }]);
        }, []);
        picked_node.children = new_nodes;
    } else {
        picked_node.dead_end = true;
    }
}

// Primality checking
function compute_primes_starting_with(nbr) {
    if (nbr != 2)
        return [ nbr * 10 + 3, nbr * 10 + 7 ];
}

// Initial tree
function create_tree(startNumbers) {
    var tree = { "children": [] };
    startNumbers.map(function(n) {
       tree.children.push({ "nbr": n });
    });
    return tree;
}

var g_nodes_count = 0;
var g_vis_tree = create_display();
var startNumbers = range(0, STARTING_RANGE);
var g_tree = create_tree(startNumbers);
update_display(g_tree, g_vis_tree);
/*
TODO:
- add transitions
- real primes
- fullscreen D3
- efficient primes caching
- input form for initial number / number list
- persist tree between refreshes
CRITICISM:
- D3 will add parasite fields to your data
*/
</script>
</body>

