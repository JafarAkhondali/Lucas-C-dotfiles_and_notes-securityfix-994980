SSH_EXPORT_FILES=".bash_dirs .bash_profile .bashrc* .gdbinit .gitconfig .inputrc .screenrc .tmux.conf .vimrc* .zshrc"
SSH_EXPORT_TMP_DIR="/tmp/$USER"
SSH_LOG_DIR=~/ssh_logs
VISITED_HOSTS_LOG_FILE=~/.visited

# Will create a remote $HOME dir if needed 
# If it fails, config files will still be kept int remote $SSH_EXPORT_TMP_DIR
# DO NOT use sshl in that cmd.
exportSshFiles () {      # export $SSH_EXPORT_FILES to a remote host $1
    local prev_dir=$PWD
    cd $BASHRC_DIR

    if [ "$1" = "--cleanup" ]; then
        local del_flag="--delete"
        shift
    fi

    local tmp_dir=$(mktemp -d /tmp/BashConf_$USER.XXXXXX)
    cp -r $SSH_EXPORT_FILES $tmp_dir

    exportSshFilesCleanup () { rm -rf $tmp_dir ; cd $prev_dir ; }
    trap 'e=$? ; trap - RETURN EXIT INT TERM HUP QUIT ; exportSshFilesCleanup ; $(exit $e)' RETURN EXIT INT TERM HUP QUIT

    for dst in "$@"; do
        local dst_host=${dst%:*}
        dst_host=$(fqdn $dst_host 2>/dev/null || echo $dst_host)
        local dst_dir=\$HOME
        if [[ $dst =~ : ]]; then
            dst_dir=${dst#*:}
            [[ $dst_dir =~ ^/ ]] || dst_dir="\$HOME/$dst_dir"
        fi

        local install_bash_cmd="
find $tmp_dir -type f -exec chmod -w {} + ;
[ -e $SSH_EXPORT_TMP_DIR ] || mkdir $SSH_EXPORT_TMP_DIR || exit 1 ;
rsync -a $del_flag $tmp_dir/ $SSH_EXPORT_TMP_DIR
rm -rf $tmp_dir ;
[ -e $dst_dir ] || ( sudo mkdir $dst_dir && sudo chown $USER $dst_dir ) || exit 1 ;
rsync -a $del_flag $SSH_EXPORT_TMP_DIR/ $dst_dir
rm -rf $SSH_EXPORT_TMP_DIR
"

        rsync -avz $del_flag $tmp_dir $dst_host:/tmp || return 1
        # WARNING: ssh does NOT behave the same when cmd is piped as stdin
        ssh -t $dst_host "$install_bash_cmd" || return 1
    done
}

ssh_setup () {
    local agentConfFile=~/.ssh/.ssh-agent.sh
    [ "$1" == "-f" ] && killall ssh-agent
    if [ -r $agentConfFile ]; then
        source $agentConfFile >/dev/null
        if ! ps -eo args | grep -q 'ssh-agent$' || [ -z "$SSH_AGENT_PID" ] || ! ps -eo pid | grep -q $SSH_AGENT_PID; then
            ssh-agent >$agentConfFile
            source $agentConfFile >/dev/null
        fi
    fi
    if ! ssh-add -l 2>&1 >/dev/null; then
        for pub_file_key in ~/.ssh/*.pub; do
            local priv_file_key=${pub_file_key%.pub}
            [ -r $priv_file_key ] && ssh-add $priv_file_key
        done
    fi
}

unset ssh; unalias ssh 2>/dev/null
ssh () {
    ssh_setup
    $(which ssh) "$@"
}

unset scp; unalias scp 2>/dev/null
scp () {
    ssh_setup
    $(which scp) "$@"
}

unset rsync; unalias rsync 2>/dev/null
rsync () {
    ssh_setup
    $(which rsync) "$@"
}

ssh_with_tmp_home () {
    local dst=$(fqdn $1 2>/dev/null || echo $1) ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    ssh -t $dst "HOME=$SSH_EXPORT_TMP_DIR ; cd ; bash --rcfile .bashrc"
}

visit () {              # ssh to a host after calling 'exportSshFiles'. List visited hosts in ~/.visited
    local dst=$(fqdn $1 2>/dev/null || echo $1) ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    if exportSshFiles $dst; then
        grep -q $dst $VISITED_HOSTS_LOG_FILE || echo $dst >> $VISITED_HOSTS_LOG_FILE
        ssh $dst
    else
        echo "$(tput setaf 1)exportSshFiles FAILED: $(tput sgr0) sudo rights probably missing on $dst, fallback to a /tmp \$HOME"
        ssh_with_tmp_home $dst
    fi
}

rmRemoteHome () {       # remove remote /home/$USER
    local dst=$1 ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    # Backup .*history files
        local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
        scp $dst:~/.*history $logdir
        for f in $logdir/.*history; do mv $f $logdir/$(date +%Y-%m-%d-%Hh_%Mm_%Ss)$(basename $f) ; done
    ssh -t $dst "rm -rf /home/$USER/* && sudo rmdir /home/$USER" || return 1
    [ -w $VISITED_HOSTS_LOG_FILE ] && sed -i -e /$1/d $VISITED_HOSTS_LOG_FILE
}

sshl () { # Ssh with console logs, useful but not good for security
    local params="$*"
    while [ "${1:0:1}" = "-" ]; do
        [[ ${1:${#1}-1} =~ "[bcDeFiLlmOopRSw]" ]] && shift
        shift
    done
    local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
    local logfile=$logdir/$(date +"%Y-%m-%d-%Hh_%Mm_%Ss").log
    script -c "ssh $params" $logfile
    gzip $logfile &
}
