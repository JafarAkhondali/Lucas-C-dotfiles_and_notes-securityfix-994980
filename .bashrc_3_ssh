HID_CONF_FILES=".bash_dirs .bash_profile .bashrc* .gitconfig .inputrc .screenrc .vimrc* .zshrc"
SSH_LOG_DIR=~/ssh_logs
VISITED_HOSTS_LOG_FILE=~/.visited

# Will create a remote $HOME dir if needed (and then only, will ask for pswd).
# Should be run in $HOME. DO NOT use sshl in that cmd.
exportHidConf () {      # export $HID_CONF_FILES to a remote host $1. If is_true $2, keep ssh connection open
    #local keep_ssh_open_cmd ; is_true $2 && keep_ssh_open_cmd='/bin/bash -i' # --rcfile ~/.bash_profile

    exportHidConfCleanup () {
        set +f
        find /tmp/ -maxdepth 1 -name 'HidConf_*' -exec rm -rf {} \;
    }
    trap "e=$? ; exportHidConfCleanup ; exit $e" EXIT INT TERM HUP QUIT

    local tmpDir=/tmp/HidConf_$(date +"%Y-%m-%d-%Hh_%Mm_%Ss")
    mkdir $tmpDir
    cd
    cp $HID_CONF_FILES $tmpDir

    local install_bash_cmd="
[ '/' = \"\$(pwd)\" ] && ( sudo mkdir /home/$USER && sudo chown $USER /home/$USER ) ;
rm -f $HID_CONF_FILES ;
cd $tmpDir ;
mv -f $HID_CONF_FILES \$(cd && pwd) ;
cd ;
chmod -w $HID_CONF_FILES ;
rm -rf $tmpDir ;
$keep_ssh_open_cmd
"

    set -f # disable wildcard expansion so that it's expanded remotely, not locally

    for dst in $@; do
        dst=$(fqdn $dst)
        scp -r $tmpDir $dst:/tmp || return 1
        # WARNING: ssh does NOT behave the same when cmd is piped as stdin
        ssh -t $dst "$install_bash_cmd" || return 1
    done
    
    trap - EXIT INT TERM HUP QUIT
    exportHidConfCleanup
}

ssh_setup () {
    local agentConfFile=~/.ssh/.ssh-agent.sh
    if ps -e | grep -q 'ssh-agent$'; then
        [ -r $agentConfFile ] && source $agentConfFile >/dev/null
        return
    fi
    ssh-agent >$agentConfFile
    source $agentConfFile >/dev/null
    for pub_file_key in ~/.ssh/*.pub; do
        local priv_file_key=${pub_file_key%.pub}
        [ -r $priv_file_key ] && ssh-add $priv_file_key
    done
}

unset ssh; unalias ssh 2>/dev/null
ssh () {
    ssh_setup
    $(which ssh) $@
}

visit () {              # ssh to a host after calling 'exportHidConf'. List visited hosts in ~/.visited
    local dst=$(fqdn $1) ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    cd
    exportHidConf $dst || return 1
    cd $OLDPWD
    grep -q $dst $VISITED_HOSTS_LOG_FILE || echo $dst >> $VISITED_HOSTS_LOG_FILE
    ssh $dst
}

rmRemoteHome () {       # remove remote /home/$USER
    local dst=$1 ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    # Backup .*history files
        local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
        scp $dst:~/.*history $logdir
        for f in $logdir/.*history; do mv $f $logdir/$(date +%Y-%m-%d-%Hh_%Mm_%Ss)$(basename $f) ; done
    ssh -t $dst "rm -rf /home/$USER/* && sudo rmdir /home/$USER" || return 1
    [ -w $VISITED_HOSTS_LOG_FILE ] && sed -i -e /$1/d $VISITED_HOSTS_LOG_FILE
}

sshl () { # Ssh with console logs, useful but not good for security
    local params="$*"
    while [ "${1:0:1}" = "-" ]; do
        [[ ${1:${#1}-1} =~ "[bcDeFiLlmOopRSw]" ]] && shift
        shift
    done
    local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
    local logfile=$logdir/$(date +"%Y-%m-%d-%Hh_%Mm_%Ss").log
    script -c "ssh $params" $logfile
    gzip $logfile &
}