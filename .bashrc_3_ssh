BASH_CONF_FILES=".bash_dirs .bash_profile .bashrc* .gitconfig .inputrc .screenrc .vimrc* .zshrc"
BASH_CONF_TMP_DIR="/tmp/$USER"
SSH_LOG_DIR=~/ssh_logs
VISITED_HOSTS_LOG_FILE=~/.visited

# Will create a remote $HOME dir if needed 
# If it fails, config files will still be kept int remote $BASH_CONF_TMP_DIR
# Should be run in $HOME. DO NOT use sshl in that cmd.
exportBashConf () {      # export $BASH_CONF_FILES to a remote host $1, and .bash_history the 1st time
    local dst_host=$(echo $1 | cut -d ':' -f 1)
    dst_host=$(fqdn $dst_host 2>/dev/null || echo $dst_host)
    local dst_dir="\$HOME/$(echo $1 | cut -d ':' -f 2)"

    exportBashConfCleanup () { rm -rf $tmpDir ; }
    trap 'e=$? ; trap - RETURN EXIT INT TERM HUP QUIT ; exportBashConfCleanup ; $(exit $e)' RETURN EXIT INT TERM HUP QUIT

    local tmpDir=$(mktemp -d /tmp/BashConf_$USER.XXXXXX)
    cp -r $BASH_CONF_FILES $tmpDir
    [ -e .bash_history ] && cp .bash_history $tmpDir

    local install_bash_cmd="
[ -e ~/.bash_history ] && rm -f $tmpDir/.bash_history ;
find $tmpDir -type f -exec chmod -w {} + ;
[ -e $BASH_CONF_TMP_DIR ] || mkdir $BASH_CONF_TMP_DIR || exit 1 ;
rsync -a $tmpDir/ $BASH_CONF_TMP_DIR
rm -rf $tmpDir ;
[ -e $dst_dir ] || ( sudo mkdir $dst_dir && sudo chown $USER $dst_dir ) || exit 1 ;
rsync -a $BASH_CONF_TMP_DIR/ $dst_dir
rm -rf $BASH_CONF_TMP_DIR
"

    scp -rC $tmpDir $dst_host:/tmp || return 1
    # WARNING: ssh does NOT behave the same when cmd is piped as stdin
    ssh -t $dst_host "$install_bash_cmd" || return 1
}

ssh_setup () {
    local agentConfFile=~/.ssh/.ssh-agent.sh
    [ "$1" == "-f" ] && killall ssh-agent
    if ps -e | grep -q 'ssh-agent$'; then
        [ -r $agentConfFile ] && source $agentConfFile >/dev/null
        return
    fi
    ssh-agent >$agentConfFile
    source $agentConfFile >/dev/null
    for pub_file_key in ~/.ssh/*.pub; do
        local priv_file_key=${pub_file_key%.pub}
        [ -r $priv_file_key ] && ssh-add $priv_file_key
    done
}

unset ssh; unalias ssh 2>/dev/null
ssh () {
    ssh_setup
    $(which ssh) "$@"
}

unset scp; unalias scp 2>/dev/null
scp () {
    ssh_setup
    $(which scp) "$@"
}

visit () {              # ssh to a host after calling 'exportBashConf'. List visited hosts in ~/.visited
    local dst=$(fqdn $1 2>/dev/null || echo $1) ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    cd
    if exportBashConf $dst; then
        grep -q $dst $VISITED_HOSTS_LOG_FILE || echo $dst >> $VISITED_HOSTS_LOG_FILE
        ssh $dst
    else
        echo "$(tput setaf 1)exportBashConf FAILED: $(tput sgr0) sudo rights probably missing on $dst, fallback to a /tmp \$HOME"
        ssh -t $dst "HOME=$BASH_CONF_TMP_DIR ; cd ; bash --rcfile .bashrc"
    fi
    cd $OLDPWD
}

rmRemoteHome () {       # remove remote /home/$USER
    local dst=$1 ; [ -z $dst ] && echo "MISSING ARG: Specifiy a remote host" && return 1
    # Backup .*history files
        local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
        scp $dst:~/.*history $logdir
        for f in $logdir/.*history; do mv $f $logdir/$(date +%Y-%m-%d-%Hh_%Mm_%Ss)$(basename $f) ; done
    ssh -t $dst "rm -rf /home/$USER/* && sudo rmdir /home/$USER" || return 1
    [ -w $VISITED_HOSTS_LOG_FILE ] && sed -i -e /$1/d $VISITED_HOSTS_LOG_FILE
}

sshl () { # Ssh with console logs, useful but not good for security
    local params="$*"
    while [ "${1:0:1}" = "-" ]; do
        [[ ${1:${#1}-1} =~ "[bcDeFiLlmOopRSw]" ]] && shift
        shift
    done
    local logdir=$SSH_LOG_DIR/$1 ; [ -x $logdir ] || mkdir -p $logdir
    local logfile=$logdir/$(date +"%Y-%m-%d-%Hh_%Mm_%Ss").log
    script -c "ssh $params" $logfile
    gzip $logfile &
}
